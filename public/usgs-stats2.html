<!DOCTYPE html>
<html lang="en">
  <head>
    <Set-Cookie: ACookieAvailableCrossSite; SameSite=None;>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=\, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    
    <style>
     
    </style>

    <title>ST JOE MI RIVER GAGES</title> 
  </head>
  <body>
    <body style="background-color:#242424;">

    <div id="stJoe"><h2><font color=#0049ad>ST. JOSEPH RIVER USGS GAGES</font></div>
    <script>
        (async () => {
        //Pull from USGS statistic Service to find out what daily mean flow is
        //3-2-2020 pulled todays date and located daily statistics for USGS
        //5-25-2020 both functions refigured to receive station code as input, easier understand
        //gets data from each USGS station via fetch
        //5-26 working great, return station object and status, need to process multiple stations
        const currentFlow = async function () {
            const sta_list = ["04096405","04096515","04097500","040975299","04097540","04099000","04100500","04101000","04101500","04101535","04101800","04102500"];
            //mainstem only - const sta_list = ["04096405","04097500","04099000","04101000","04101500"];
            const urlStart = 'https://waterservices.usgs.gov/nwis/iv/?format=json&sites=', urlEnd = '&parameterCd=00060,00065&siteStatus=all';
            let gageObject = {}, gageList = [];
            for (i = 0; i < sta_list.length; i++) {
                const api_url = (urlStart + sta_list[i] + urlEnd);               
                const response = await fetch(api_url);
                const data = await response.json();
                const sta_data = data.value, sta_flow = sta_data.timeSeries[0], sta_gage = sta_data.timeSeries[1], sta_flow_val = sta_flow.values[0].value[0].value;
                gageObject = {siteName: sta_flow.sourceInfo.siteName, siteCode: sta_flow.sourceInfo.siteCode[0].value, 
                            siteFlow: Number(sta_flow.values[0].value[0].value), gageHeight: Number(sta_gage.values[0].value[0].value),
                            dateTime: sta_flow.values[0].value[0].dateTime, gageStatus:"", gagePercent:""};
                gageList[i] = gageObject;
                //console.log(gageObject);
            };
            return gageList;
        };  

    const gageStatus = async function (stationList) {
        const stationData = []; //Final array of data for each station in stationObject List
        for (z in stationList) {
            console.log(z, stationList[z]);
            //generate url params using USGS siteCode from stationObject
            const urlStart = 'https://waterservices.usgs.gov/nwis/stat/?format=rdb&sites=', urlEnd = '&statReportType=daily&statTypeCd=all';
            const api_url = (urlStart + stationList[z].siteCode + urlEnd);               
            console.log(api_url);
            const fetchData = await fetch(api_url);
            const dataText = await fetchData.text();
            const dataLines = dataText.split("\n");
            let dailyMean = 0, dailyStats = {"mean":0};
            //Need to find todays date to compare current discharge level against
            const today = new Date(), monthNum = (today.getMonth() + 1), dayNum = today.getDate(), yearNum = today.getFullYear();
            console.log("Today's Date: " + monthNum + "-" + dayNum + "-" + yearNum);
            const usgsLabels = {"p05":'LOW', "p10":'MUCH BELOW NORMAL', "p20":'BELOW NORMAL', "p25":'BELOW NORMAL', 
                "p50":'NORMAL', "p75": 'NORMAL', "p80":'ABOVE NORMAL', "p90":'ABOVE NORMAL', "p95":'MUCH ABOVE NORMAL'};
                //start at the January 1st to match date to today's date, line 50 in the tab separated text file
            for (x=49;dailyStats.mean==0;x++) {
                const dataTabs = dataLines[x].split("\t");
                dailyStats.mean = (dataTabs[5] == monthNum && dataTabs[6] == dayNum) ? (dataTabs[14]) : 0;
                dailyStats.mean != 0 ? (dailyStats = {"mon":dataTabs[5],"day":dataTabs[6], "maxYear": dataTabs[10], "maxFlow": dataTabs[11], 
                "minYear": dataTabs[12], "minFlow": dataTabs[13], "mean": dataTabs[14], "p05": dataTabs[15], "p10": dataTabs[16], 
                "p20": dataTabs[17], "p25": dataTabs[18], "p50":dataTabs[19], "p75":dataTabs[20],"p80":dataTabs[21],"p90":dataTabs[22],"p95":dataTabs[23]}):"";
            };
            //find percentile current flow 
            for (x=7;x<Object.entries(dailyStats).length;x++) {
                stationList[z].siteFlow >= Object.entries(dailyStats)[x][1]? (stationList[z].gagePercent = Object.entries(dailyStats)[x][0],
                stationList[z].gageStatus = usgsLabels[stationList[z].gagePercent]):"";
                //console.log(`dailyStats: ${Object.entries(dailyStats)[x][1]} siteFlow: ${stationObject.siteFlow} percent: ${stationObject.gagePercent} status: ${stationObject.gageStatus}`);
                //console.log(`x:${x} ${Object.entries(dailyStats)[x][1]}`);
            }
            const stationRecord = {"ID": Number(stationList[z].siteCode), "stationInfo": stationList[z], "dailyStats": dailyStats};
            stationData[z] = stationRecord;
            
        };
        return stationData;
    };    
    
    const flowStatus = await currentFlow();
    //console.log(await flowStatus);
    const stationStatus = await gageStatus(flowStatus);
    //console.log(`Station current status is: ${stationStatus}`);
    console.log(await stationStatus);
    })();
    </script> 
  </body>
</html> 